# Using SDEverywhere to Make a Vensim Model into a Web Application

Revised: 2019-07-24

This tutorial shows you how to take your Vensim model and turn it into an interactive web application using the open-source SDEverywhere toolkit. SDEverywhere currently requires the macOS operating system in development, but the resulting web app can be run on any web server, or even offline using the Firefox browser.

## Getting started

### Install SDEverywhere

First install SDEverywhere using the instructions in the "Installing" section of the README.

### Install the Java JDK

The Emscripten compiler uses Java to run the Google Closure compiler, which shrinks generated JavaScript code size considerably. Download and install the JDK from the [Oracle download page](https://www.oracle.com/technetwork/java/javase/downloads/index.html). Be sure to install the JDK and not the JRE.

### Install Emscripten

The Emscripten SDK is a tool that converts the C code generated by SDEverywhere into JavaScript, and then compiles it into WebAssembly that runs in a browser.

1. You will need Python version 2.7.12 or later. It will already be present on a recent version of macOS. To download a newer Python version that the one that ships with macOS, download and install the [latest Python 2.7.x version](https://www.python.org/downloads/).

~~~
python --version
~~~

2. Install SSL certificates in Python. This is necessary for the Emscripten SDK to download additional files.

~~~
cd /Applications/Python\ 2.7/
./Install\ Certificates.command
~~~

3. Download the latest [Emscripten SDK release](https://github.com/emscripten-core/emsdk/archive/master.zip).

4. Unzip `emsdk-master.zip`. Rename the `emsdk-master` directory to `emsdk` in a location of your choice. Go to that directory in your terminal.

5. Install and activate the Emscripten SDK.

~~~
./emsdk update
./emsdk install latest
./emsdk activate latest
~~~

6. You will need to run the following command from the `emsdk` directory every time you want to use Emscripten—that is, every time you generate web apps with SDEverywhere. This will temporarily use the Node and clang compiler bundled with Emscripten. When you close the terminal tab, the Emscripten environment will go away.

~~~
source ./emsdk_env.sh
~~~

7. Test your Emscripten installation.

~~~
emcc -v
~~~

8. [Optional] Edit your shell profile. If you expect to use SDE frequently, you can edit your shell profile script to automatically set up the Emscripten environment. On macOS Mojave, the current best way is to add the following to you `$HOME/.bash_profile` file:

~~~
##  Setup for SDE making webapps; this loads the Emscripten settings, and then overrides NODE_JS to the NVS version
source $HOME/replaceme_PATHTO/emsdk/emsdk_env.sh > /dev/null
NODE_JS='$HOME/.nvs/default/bin/node'
~~~

where `$HOME` is likely `/Users/<yourusername>` and `replaceme_PATHTO` is folder path to where you place your `emsdk` directory in Step 4 above.

## Generating model code and validating it

The first step generates C code for your model and validates it against a Vensim run. This is necessary to ensure that SDEverywhere can handle all the Vensim constructs in your model and that it generates correct code for your equations. In a later step, the C code will be converted to JavaScript code that will be embedded in your web app.

Create a model directory.

Copy the model `.mdl` file into the model directory using a short, lower-case name, since you will be typing it in SDEverywhere commands. The placeholder for the model name (without the `.mdl` extension) in these instructions is `{model}`.

Run the model in Vensim using `{model}` as the run name.

Export the `.vdf` run in Vensim DAT format using Model > Export Dataset.

Generate C code, compile and run it, and validate the results against Vensim.

~~~
sde test {model}
~~~

SDEverywhere will list discrepancies between the Vensim run and data generated by the C model, up to a default precision of 10⁻⁵. If you are getting errors, and somewhat less precision, such as 10⁻³, is acceptable, run the test with the `-p` option.

~~~
sde test -p 1e-3 {model}
~~~

## Designing your web app

SDEverywhere generates a web application based on a standard template merged with app configuration in CSV files. Refer to the *SDEverywhere Web App Configuration Reference* document for details. There is a fully worked-out example in the `models/sir` directory.

Copy the `config` directory from the `notes` directory to your model directory. This will give you empty CSV files with the proper headers.

If you use Excel to edit the CSV files, open them from the Finder instead of from within Excel. This will avoid the Text Import Wizard.

## Generating the web app

The development scripts assume that your model is in the `model` subdirectory of your project directory. The CSV config files go in the `model/config` directory. You can run the scripts from the project directory or any of its subdirectories.

1. Activate the Emscripten SDK in your `emsdk` directory (see [Install Emscripten](#install-emscripten) above).

~~~
source ./emsdk_env.sh
~~~

2. Generate WebAssembly code for the model and embed it in a web app.

~~~
cd model
sde generate --genhtml {model}
~~~

3. Start the development web server, and then open the web app with the URL it prints.

~~~
npx http-server build/web -c-1 -o
~~~

If you are using your own web server, configure it to serve files from the `model/build/web` directory.

The files to deploy to a web server in production are found in the `model/build/web` directory.
